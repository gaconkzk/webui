<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./bower_components/paper-button/paper-button.html">
<link rel="import" href="./bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="./bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="./bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="./bower_components/app-layout/app-layout.html">
<link rel="import" href="./bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./bower_components/iron-icon/iron-icon.html">
<link rel="import" href="./bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./bower_components/paper-input/paper-input.html">

<dom-module id="the-flies">
    <template>
        <iron-ajax id="dataService" url="/greeting" on-response="updateData"></iron-ajax>
        <iron-ajax
                id="logout"
                url="/logout"
                method="POST"
                content-type="application/x-www-form-urlencoded"
                handle-as="json"
                on-response="_handleAjaxPostResponse"
                on-error="_handleAjaxPostError"
        ></iron-ajax>
        <iron-ajax
                id="login"
                url="/user"
                method="GET"
                content-type="application/x-www-form-urlencoded"
                handle-as="json"
                on-response="_loginSuccess"
                on-error="_loginError"
        ></iron-ajax>
        <app-toolbar>
            <paper-icon-button icon="menu" on-tap="toggleDrawer"></paper-icon-button>
            <div main-title>The Flies</div>
            <paper-button id="loginBtn" on-tap="showLogin" hidden$="[[authenticated]]">Login</paper-button>
            <paper-button id="logoutBtn" on-tap="doLogout" hidden$="[[!authenticated]]">Logout</paper-button>
        </app-toolbar>

        <div class="fit" hidden$="[[!authenticated]]">
            <h1>Greeting</h1>
            <div>
                <p>The username is [[username]]</p>

                <paper-button on-click="getData">Get Server Data</paper-button>
            </div>
        </div>

        <div class="fit" hidden$="[[authenticated]]">
            <div>
                <p>Please <paper-button on-click="showLogin" raised>Login</paper-button> to see your greeting</p>
            </div>
        </div>


        <app-drawer id="drawer" align="left">
            <div class="drawer-contents">
                <template is="dom-repeat" id="menu" items="[[items]]">
                    <paper-icon-item>
                        <iron-icon icon="[[item]]" item-con></iron-icon>
                        <span>[[item]]</span>
                    </paper-icon-item>
                </template>
            </div>
        </app-drawer>

        <paper-dialog id="loginDlg">
            <h2>Login</h2>
            <form is="iron-from" id="form" method="get" action="/user">
                <paper-input label="Username" id="username" type="text" value="{{username}}" required></paper-input>
                <paper-input label="Password" id="password" type="password" value="{{password}}"required></paper-input>

                <paper-button raised on-tap="submitForm">Login</paper-button>
            </form>
        </paper-dialog>
    </template>
    <script>
        Polymer({
             is: "the-flies",
             properties: {
                greeting: {
                    type: Object,
                    value: {
                        "id": "ahihi",
                        "content": "welcome to my first training session"
                    }
                },
                username: String,
                password: String,
                items: {
                    type: Array,
                    value: ['inbox','favorite','polymer']
                },
                authenticated: {
                    type: Boolean,
                    value: false
                },
                credential: {
                    type: Object,
                    computed: '_computeCredential(username,password)'
                }
             },

             ready: function() {
                this.$.login.generateRequest();
             },

             listeners: {
             },
             _computeCredential: function(username, password) {
                return username && password ? { "username" : username, "password": password } : null;
             },
             _loginSuccess: function(evt) {
                var response = evt.detail.response;
                this.authenticated = response.authenticated;
                this.username = response.name;
             },
             _loginError: function(evt) {
                this.authenticated = false;
                this.username = "";
                this.password = "";
             },
             getData: function() {
                this.$.dataService.generateRequest();
             },
             updateData: function(evt) {
                this.greeting = evt.detail.response;
             },
             toggleDrawer: function() {
                this.$.drawer.toggle();
             },
             showLogin: function() {
                this.$.loginDlg.open();
             },
             doLogout: function() {
                this.$.login.headers = {"authorization": "Basic " + btoa(":")};
                this.$.login.generateRequest();
             },
             submitForm: function() {
                this.$.login.headers = this.credential? {"authorization": "Basic " + btoa(this.credential.username + ":" + this.credential.password)} : {};
                this.$.login.generateRequest();
             }
        });
    </script>
</dom-module>